<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Report Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; color: #4A5568; font-weight: 500; }
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #E2E8F0;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
        }
        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: #4299E1;
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.5);
        }
        .generated-text {
            white-space: pre-wrap;
            background-color: #edf2f7;
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: monospace;
            color: #2d3748;
            border: 1px solid #e2e8f0;
            min-height: 200px;
        }
        .modal { transition: opacity 0.3s ease; }
        .toast { transition: opacity 0.5s, transform 0.5s; }
        .kpi-card {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-left: 4px solid #e2e8f0; /* Default border */
            border-radius: 0.75rem;
            padding: 1rem;
            transition: border-color 0.3s ease;
        }
        .kpi-card.blue { border-left-color: rgb(59, 130, 246); }
        .kpi-card.orange { border-left-color: rgb(249, 115, 22); }
        .kpi-card.red { border-left-color: rgb(220, 38, 38); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-8xl">
        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            
            <header class="mb-8 text-center">
                <h1 class="text-3xl font-bold text-gray-900">Sales Report Calculator</h1>
                <p class="text-gray-500 mt-2">Your data is now saved online and accessible from any device.</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Input Section -->
                <div class="space-y-4">
                    <div class="input-group">
                        <label for="shopName">Company / Branch Name</label>
                        <input type="text" id="shopName" value="SMKT" placeholder="E.g., SMKT">
                    </div>
                    
                    <div class="input-group">
                        <label for="salesDate">Sales Date</label>
                        <input type="date" id="salesDate">
                    </div>

                    <div class="input-group">
                        <label for="monthlyTarget">Monthly Sales Target (RM)</label>
                        <input type="number" id="monthlyTarget" placeholder="E.g., 492000.00" step="0.01">
                    </div>

                    <div class="input-group">
                        <label for="baselineTarget">Baseline (RM)</label>
                        <input type="number" id="baselineTarget" placeholder="E.g., 200000.00" step="0.01">
                    </div>

                    <div class="input-group">
                        <label for="upToDateSales">Up to Date Sales (Before Today) (RM)</label>
                        <input type="number" id="upToDateSales" placeholder="Calculated automatically" readonly class="bg-gray-100">
                    </div>
                    
                    <div class="input-group">
                        <label for="coreProduct">Core Product Sales (RM)</label>
                        <input type="number" id="coreProduct" placeholder="E.g., 17795.00" step="0.01">
                        <textarea id="coreProductItems" class="mt-2" rows="2" placeholder="Item list (one per line)..."></textarea>
                    </div>

                    <div class="input-group">
                        <label for="accessories">Accessories Sales (RM)</label>
                        <input type="number" id="accessories" placeholder="E.g., 227.00" step="0.01">
                        <textarea id="accessoriesItems" class="mt-2" rows="2" placeholder="Item list (one per line)..."></textarea>
                    </div>

                    <div class="input-group">
                        <label for="warranty">Warranty Sales (RM)</label>
                        <input type="number" id="warranty" placeholder="Fill if available" step="0.01">
                        <textarea id="warrantyItems" class="mt-2" rows="2" placeholder="Item list (one per line)..."></textarea>
                    </div>

                    <div class="input-group">
                        <label for="tradeIn">Trade In Sales (RM)</label>
                        <input type="number" id="tradeIn" placeholder="Fill if available" step="0.01">
                        <textarea id="tradeInItems" class="mt-2" rows="2" placeholder="Item list (one per line)..."></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="input-group">
                            <label for="currentDay">Day</label>
                            <input type="number" id="currentDay" placeholder="Auto" readonly class="bg-gray-100">
                        </div>
                        <div class="input-group">
                            <label for="totalDays">Total Days</label>
                            <input type="number" id="totalDays" placeholder="Auto" readonly class="bg-gray-100">
                        </div>
                    </div>
                    
                    <button id="saveBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">
                        Save Report
                    </button>
                    <button id="historyBtn" class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition duration-300 shadow-md">
                        View History
                    </button>
                </div>
                
                <!-- Output Section -->
                <div>
                    <label class="block mb-2 font-medium text-gray-700">Generated Report (Live Preview)</label>
                    <div id="output" class="generated-text">The report will be displayed here...</div>
                    <button id="copyBtn" class="mt-4 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 shadow-md">
                        Copy Text
                    </button>
                </div>
            </div>
        </div>
        <footer class="text-center mt-6 text-sm text-gray-400">
            <p>&copy; 2024 Created for Samsung KTCC Mall (Terengganu).</p>
        </footer>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold">Monthly Sales Dashboard</h2>
                <input type="month" id="historyMonth" class="p-2 border rounded-lg">
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-4xl">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto space-y-6">
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 text-center">
                    <div class="kpi-card">
                        <p class="text-sm text-gray-500">Total Sales</p>
                        <p id="kpi-total-sales" class="text-2xl font-bold text-blue-600">RM 0.00</p>
                    </div>
                    <div class="kpi-card">
                        <p class="text-sm text-gray-500">Remaining to Baseline</p>
                        <p id="kpi-remaining-baseline" class="text-2xl font-bold">RM 0.00</p>
                    </div>
                    <div class="kpi-card">
                        <p class="text-sm text-gray-500">Remaining to Target</p>
                        <p id="kpi-remaining-target" class="text-2xl font-bold">RM 0.00</p>
                    </div>
                    <div class="kpi-card">
                        <p class="text-sm text-gray-500">Average Daily Sales</p>
                        <p id="kpi-avg-daily" class="text-2xl font-bold text-gray-700">RM 0.00</p>
                    </div>
                    <div class="kpi-card">
                        <p class="text-sm text-gray-500">Required Daily Average</p>
                        <p id="kpi-required-avg" class="text-2xl font-bold text-indigo-600">RM 0.00</p>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-2">Sales Flow</h3>
                    <div class="bg-gray-50 p-2 rounded-lg">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2">Daily Breakdown</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2">Date</th>
                                    <th class="p-2 text-right">Core (RM)</th>
                                    <th class="p-2 text-right">Acc. (RM)</th>
                                    <th class="p-2 text-right">War. (RM)</th>
                                    <th class="p-2 text-right">TradeIn (RM)</th>
                                    <th class="p-2 text-right font-bold">Daily (RM)</th>
                                    <th class="p-2 text-right font-bold">Up to Date (RM)</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-10">
        <p id="toast-message"></p>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const SalesApp = {
            db: null,
            auth: null,
            appId: 'sales-calculator-app',
            allReports: [],
            salesChartInstance: null,

            elements: {
                container: document.getElementById('app-container'),
                salesDate: document.getElementById('salesDate'),
                saveBtn: document.getElementById('saveBtn'),
                copyBtn: document.getElementById('copyBtn'),
                historyBtn: document.getElementById('historyBtn'),
                historyModal: document.getElementById('historyModal'),
                closeModalBtn: document.getElementById('closeModalBtn'),
                historyMonth: document.getElementById('historyMonth'),
                salesChart: document.getElementById('salesChart'),
                historyTableBody: document.getElementById('historyTableBody'),
                toast: document.getElementById('toast'),
                toastMessage: document.getElementById('toast-message'),
                output: document.getElementById('output'),
                shopName: document.getElementById('shopName'),
                monthlyTarget: document.getElementById('monthlyTarget'),
                baselineTarget: document.getElementById('baselineTarget'),
                upToDateSales: document.getElementById('upToDateSales'),
                coreProduct: document.getElementById('coreProduct'),
                coreProductItems: document.getElementById('coreProductItems'),
                accessories: document.getElementById('accessories'),
                accessoriesItems: document.getElementById('accessoriesItems'),
                warranty: document.getElementById('warranty'),
                warrantyItems: document.getElementById('warrantyItems'),
                tradeIn: document.getElementById('tradeIn'),
                tradeInItems: document.getElementById('tradeInItems'),
                currentDay: document.getElementById('currentDay'),
                totalDays: document.getElementById('totalDays'),
                kpiTotalSales: document.getElementById('kpi-total-sales'),
                kpiRemainingBaseline: document.getElementById('kpi-remaining-baseline'),
                kpiRemainingTarget: document.getElementById('kpi-remaining-target'),
                kpiAvgDaily: document.getElementById('kpi-avg-daily'),
                kpiRequiredAvg: document.getElementById('kpi-required-avg'),
            },

            async initFirebase() {
                try {
                    const firebaseConfig = {
                        apiKey: "AIzaSyCWR7vfKgtNZrXutLmdd0163EhMUrLkBQA",
                        authDomain: "sales-report-app-ab55e.firebaseapp.com",
                        projectId: "sales-report-app-ab55e",
                        storageBucket: "sales-report-app-ab55e.appspot.com",
                        messagingSenderId: "357226489797",
                        appId: "1:357226489797:web:7beee72678971a468b8dac",
                        measurementId: "G-03PBVT3BDX"
                    };
                    const app = initializeApp(firebaseConfig);
                    this.db = getFirestore(app);
                    this.auth = getAuth(app);
                    await signInAnonymously(this.auth);
                    return true;
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    this.showError(`Database Connection Error! Details: ${error.message}`);
                    return false;
                }
            },

            bindEvents() {
                this.elements.salesDate.addEventListener('change', () => {
                    this.updateDateFields();
                    this.loadDataForDate(this.elements.salesDate.value);
                });
                
                const inputsToTrack = ['shopName', 'monthlyTarget', 'baselineTarget', 'coreProduct', 'coreProductItems', 'accessories', 'accessoriesItems', 'warranty', 'warrantyItems', 'tradeIn', 'tradeInItems'];
                inputsToTrack.forEach(id => {
                    this.elements[id]?.addEventListener('input', () => this.liveUpdateReport());
                });

                this.elements.saveBtn.addEventListener('click', () => this.saveReport());
                this.elements.copyBtn.addEventListener('click', () => this.copyReport());
                this.elements.historyBtn.addEventListener('click', () => this.showHistory());
                this.elements.closeModalBtn.addEventListener('click', () => this.hideModal());
                this.elements.historyModal.addEventListener('click', (e) => {
                    if (e.target === this.elements.historyModal) this.hideModal();
                });
                this.elements.historyMonth.addEventListener('change', () => this.updateHistoryDashboard());
            },

            getCurrentDataFromForm() {
                const data = {
                    shopName: this.elements.shopName.value,
                    monthlyTarget: parseFloat(this.elements.monthlyTarget.value) || 0,
                    baselineTarget: parseFloat(this.elements.baselineTarget.value) || 0,
                    previousUpToDateSales: parseFloat(this.elements.upToDateSales.value) || 0,
                    coreProductSales: parseFloat(this.elements.coreProduct.value) || 0,
                    accessoriesSales: parseFloat(this.elements.accessories.value) || 0,
                    warrantySales: parseFloat(this.elements.warranty.value) || 0,
                    tradeInSales: parseFloat(this.elements.tradeIn.value) || 0,
                    coreProductItems: this.elements.coreProductItems.value.trim(),
                    accessoriesItems: this.elements.accessoriesItems.value.trim(),
                    warrantyItems: this.elements.warrantyItems.value.trim(),
                    tradeInItems: this.elements.tradeInItems.value.trim(),
                    dateKey: this.elements.salesDate.value
                };
                const dailySales = data.coreProductSales + data.accessoriesSales + data.warrantySales + data.tradeInSales;
                data.newUpToDateSales = data.previousUpToDateSales + dailySales;
                return data;
            },
            
            liveUpdateReport() {
                const data = this.getCurrentDataFromForm();
                this.generateReport(data);
            },

            async saveReport() {
                const data = this.getCurrentDataFromForm();
                try {
                    const reportRef = doc(this.db, `artifacts/${this.appId}/public/data/salesReports/${data.dateKey}`);
                    await setDoc(reportRef, data);

                    const configRef = doc(this.db, `artifacts/${this.appId}/public/data/salesConfig/config`);
                    await setDoc(configRef, { 
                        shopName: data.shopName, 
                        monthlyTarget: data.monthlyTarget,
                        baselineTarget: data.baselineTarget
                    }, { merge: true });

                    this.showToast("Report saved successfully!");
                } catch (error) {
                    console.error("Error saving data:", error);
                    this.showToast("Failed to save report.", false);
                }
            },

            generateReport(data) {
                const [year, month, day] = data.dateKey.split('-').map(Number);
                const currentDay = day;
                const totalDays = new Date(year, month, 0).getDate();
                
                const dailySales = data.coreProductSales + data.accessoriesSales + data.warrantySales + data.tradeInSales;
                const upToDatePercent = data.monthlyTarget > 0 ? (data.newUpToDateSales / data.monthlyTarget) * 100 : 0;
                const estimatedClosing = currentDay > 0 ? (data.newUpToDateSales / currentDay) * totalDays : 0;
                const estimatedClosingPercent = data.monthlyTarget > 0 ? (estimatedClosing / data.monthlyTarget) * 100 : 0;
                
                const formattedDisplayDate = `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;

                let indicator = '';
                if (data.monthlyTarget > 0 && data.newUpToDateSales >= data.monthlyTarget) {
                    indicator = 'Target Achieved! ðŸŽ‰';
                } else if (data.baselineTarget > 0 && data.newUpToDateSales >= data.baselineTarget) {
                    indicator = 'Baseline Achieved! ðŸ‘';
                }

                const breakdownParts = [];
                const categories = [
                    { title: 'Core Product', sales: data.coreProductSales, items: data.coreProductItems },
                    { title: 'Accessories', sales: data.accessoriesSales, items: data.accessoriesItems },
                    { title: 'Warranty', sales: data.warrantySales, items: data.warrantyItems },
                    { title: 'Trade In', sales: data.tradeInSales, items: data.tradeInItems },
                ];

                categories.forEach(cat => {
                    if (cat.sales > 0 || (cat.items && cat.items.length > 0)) {
                        let part = `${cat.title} : RM ${this.formatCurrency(cat.sales)}`;
                        if (cat.items) {
                            part += `\n${cat.items.split('\n').map(item => item.trim()).join('\n')}`;
                        }
                        breakdownParts.push(part);
                    }
                });
                
                const salesBreakdown = breakdownParts.join('\n\n');
                const indicatorLine = indicator ? `${indicator}\n` : '';

                const outputText = 
`${data.shopName.toUpperCase()} ${formattedDisplayDate} Sales : RM ${this.formatCurrency(dailySales)}

${salesBreakdown}

Target : RM ${this.formatCurrency(data.monthlyTarget)}
Up to Date : RM ${this.formatCurrency(data.newUpToDateSales)} (${upToDatePercent.toFixed(0)}%)
${indicatorLine}Estimated Closing : RM ${this.formatCurrency(estimatedClosing)} (${estimatedClosingPercent.toFixed(0)}%)`;

                this.elements.output.textContent = outputText;
            },
            
            async loadDataForDate(dateKey) {
                try {
                    const configRef = doc(this.db, `artifacts/${this.appId}/public/data/salesConfig/config`);
                    const configSnap = await getDoc(configRef);
                    if (configSnap.exists()) {
                        const config = configSnap.data();
                        this.elements.shopName.value = config.shopName || 'SMKT';
                        this.elements.monthlyTarget.value = config.monthlyTarget || '';
                        this.elements.baselineTarget.value = config.baselineTarget || '';
                    }

                    const reportRef = doc(this.db, `artifacts/${this.appId}/public/data/salesReports/${dateKey}`);
                    const reportSnap = await getDoc(reportRef);

                    if (reportSnap.exists()) {
                        const data = reportSnap.data();
                        this.elements.shopName.value = data.shopName || this.elements.shopName.value;
                        this.elements.monthlyTarget.value = data.monthlyTarget || this.elements.monthlyTarget.value;
                        this.elements.baselineTarget.value = data.baselineTarget || this.elements.baselineTarget.value;
                        this.elements.upToDateSales.value = data.previousUpToDateSales || 0;
                        this.elements.coreProduct.value = data.coreProductSales || '';
                        this.elements.coreProductItems.value = data.coreProductItems || '';
                        this.elements.accessories.value = data.accessoriesSales || '';
                        this.elements.accessoriesItems.value = data.accessoriesItems || '';
                        this.elements.warranty.value = data.warrantySales || '';
                        this.elements.warrantyItems.value = data.warrantyItems || '';
                        this.elements.tradeIn.value = data.tradeInSales || '';
                        this.elements.tradeInItems.value = data.tradeInItems || '';
                    } else {
                        this.resetDailyInputs();
                        const [year, month, day] = dateKey.split('-').map(Number);
                        
                        if (day === 1) {
                            this.elements.upToDateSales.value = 0;
                        } else {
                            const selectedDate = new Date(year, month - 1, day);
                            const yesterday = new Date(selectedDate);
                            yesterday.setDate(selectedDate.getDate() - 1);
                            const yesterdayKey = this.formatDate(yesterday);
                            const yesterdayRef = doc(this.db, `artifacts/${this.appId}/public/data/salesReports/${yesterdayKey}`);
                            const yesterdaySnap = await getDoc(yesterdayRef);
                            
                            if (yesterdaySnap.exists() && yesterday.getMonth() === selectedDate.getMonth()) {
                                this.elements.upToDateSales.value = yesterdaySnap.data().newUpToDateSales || 0;
                            } else {
                                this.elements.upToDateSales.value = 0;
                            }
                        }
                    }
                    this.liveUpdateReport();
                } catch (error) {
                    console.error("Error loading data:", error);
                }
            },

            resetDailyInputs() {
                ['coreProduct', 'coreProductItems', 'accessories', 'accessoriesItems', 'warranty', 'warrantyItems', 'tradeIn', 'tradeInItems'].forEach(id => {
                    this.elements[id].value = '';
                });
            },

            updateDateFields() {
                const dateValue = this.elements.salesDate.value;
                if (dateValue) {
                    const [year, month, day] = dateValue.split('-').map(Number);
                    this.elements.currentDay.value = day;
                    this.elements.totalDays.value = new Date(year, month, 0).getDate();
                }
            },
            
            copyReport() {
                navigator.clipboard.writeText(this.elements.output.textContent).then(() => {
                    this.showToast("Report copied to clipboard!");
                });
            },

            async showHistory() {
                this.elements.historyModal.classList.remove('hidden');
                setTimeout(() => this.elements.historyModal.classList.remove('opacity-0'), 10);
                this.elements.historyTableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4">Loading history...</td></tr>';
                
                try {
                    const reportsCol = collection(this.db, `artifacts/${this.appId}/public/data/salesReports`);
                    const querySnapshot = await getDocs(query(reportsCol));
                    this.allReports = [];
                    querySnapshot.forEach(doc => this.allReports.push(doc.data()));
                    this.allReports.sort((a, b) => new Date(a.dateKey) - new Date(b.dateKey));
                    
                    const today = new Date();
                    this.elements.historyMonth.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                    this.updateHistoryDashboard();

                } catch(error) {
                    console.error("Error fetching history: ", error);
                    this.elements.historyTableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-red-500">Could not load history.</td></tr>';
                }
            },
            
            updateHistoryDashboard() {
                const [year, month] = this.elements.historyMonth.value.split('-').map(Number);
                const filteredReports = this.allReports.filter(r => {
                    const [rYear, rMonth] = r.dateKey.split('-').map(Number);
                    return rYear === year && rMonth === month;
                });

                this.renderHistoryTable(filteredReports);
                this.renderHistoryChart(filteredReports, year, month);
                this.updateKpiCards(filteredReports, year, month);
            },

            updateKpiCards(reports, year, month) {
                const kpiBaselineCard = this.elements.kpiRemainingBaseline.parentElement;
                const kpiTargetCard = this.elements.kpiRemainingTarget.parentElement;
                
                [kpiBaselineCard, kpiTargetCard].forEach(card => card.classList.remove('blue', 'orange', 'red'));

                if(reports.length === 0) {
                    this.elements.kpiTotalSales.textContent = this.formatCurrency(0, true);
                    this.elements.kpiRemainingBaseline.textContent = this.formatCurrency(parseFloat(this.elements.baselineTarget.value) || 0, true);
                    this.elements.kpiRemainingTarget.textContent = this.formatCurrency(parseFloat(this.elements.monthlyTarget.value) || 0, true);
                    this.elements.kpiAvgDaily.textContent = this.formatCurrency(0, true);
                    this.elements.kpiRequiredAvg.textContent = this.formatCurrency(0, true);
                    kpiBaselineCard.classList.add('red');
                    kpiTargetCard.classList.add('red');
                    return;
                }

                const latestReport = reports[reports.length - 1];
                const totalSales = latestReport.newUpToDateSales || 0;
                const target = latestReport.monthlyTarget || 0;
                const baseline = latestReport.baselineTarget || 0;

                const remainingToTarget = Math.max(0, target - totalSales);
                const remainingToBaseline = Math.max(0, baseline - totalSales);
                
                const totalDailySales = reports.reduce((sum, r) => sum + ((r.coreProductSales || 0) + (r.accessoriesSales || 0) + (r.warrantySales || 0) + (r.tradeInSales || 0)), 0);
                const averageDailySales = reports.length > 0 ? totalDailySales / reports.length : 0;
                
                const totalDaysInMonth = new Date(year, month, 0).getDate();
                const lastDayRecorded = new Date(latestReport.dateKey).getUTCDate();
                const daysRemaining = totalDaysInMonth - lastDayRecorded;
                let requiredDailyAverage = 0;
                if (remainingToTarget > 0 && daysRemaining > 0) {
                    requiredDailyAverage = remainingToTarget / daysRemaining;
                }

                this.elements.kpiTotalSales.textContent = this.formatCurrency(totalSales, true);
                this.elements.kpiRemainingBaseline.textContent = this.formatCurrency(remainingToBaseline, true);
                this.elements.kpiRemainingTarget.textContent = this.formatCurrency(remainingToTarget, true);
                this.elements.kpiAvgDaily.textContent = this.formatCurrency(averageDailySales, true);
                this.elements.kpiRequiredAvg.textContent = this.formatCurrency(requiredDailyAverage, true);
                
                if (baseline > 0) {
                    if (totalSales >= baseline) kpiBaselineCard.classList.add('blue');
                    else if (totalSales >= baseline * 0.8) kpiBaselineCard.classList.add('orange');
                    else kpiBaselineCard.classList.add('red');
                }

                if (target > 0) {
                    if (totalSales >= target) kpiTargetCard.classList.add('blue');
                    else if (totalSales >= target * 0.8) kpiTargetCard.classList.add('orange');
                    else kpiTargetCard.classList.add('red');
                }
            },
            
            renderHistoryTable(reports) {
                this.elements.historyTableBody.innerHTML = ''; 
                if (reports.length === 0) {
                    this.elements.historyTableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4">No data for this month.</td></tr>';
                    return;
                }
                
                let totalCore = 0, totalAcc = 0, totalWar = 0, totalTradeIn = 0, totalDaily = 0;

                reports.forEach(report => {
                    const [year, month, day] = report.dateKey.split('-').map(Number);
                    const displayDate = `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
                    const dailySales = (report.coreProductSales || 0) + (report.accessoriesSales || 0) + (report.warrantySales || 0) + (report.tradeInSales || 0);
                    
                    totalCore += report.coreProductSales || 0;
                    totalAcc += report.accessoriesSales || 0;
                    totalWar += report.warrantySales || 0;
                    totalTradeIn += report.tradeInSales || 0;
                    totalDaily += dailySales;

                    const row = `
                        <tr class="border-b">
                            <td class="p-2">${displayDate}</td>
                            <td class="p-2 text-right">${this.formatCurrency(report.coreProductSales)}</td>
                            <td class="p-2 text-right">${this.formatCurrency(report.accessoriesSales)}</td>
                            <td class="p-2 text-right">${this.formatCurrency(report.warrantySales)}</td>
                            <td class="p-2 text-right">${this.formatCurrency(report.tradeInSales)}</td>
                            <td class="p-2 text-right font-bold">${this.formatCurrency(dailySales)}</td>
                            <td class="p-2 text-right font-bold">${this.formatCurrency(report.newUpToDateSales)}</td>
                        </tr>`;
                    this.elements.historyTableBody.innerHTML += row;
                });

                const finalUpToDate = reports.length > 0 ? reports[reports.length - 1].newUpToDateSales : 0;
                const totalRow = `
                    <tr class="bg-gray-200 font-bold border-t-2 border-gray-400">
                        <td class="p-2">Total</td>
                        <td class="p-2 text-right">${this.formatCurrency(totalCore)}</td>
                        <td class="p-2 text-right">${this.formatCurrency(totalAcc)}</td>
                        <td class="p-2 text-right">${this.formatCurrency(totalWar)}</td>
                        <td class="p-2 text-right">${this.formatCurrency(totalTradeIn)}</td>
                        <td class="p-2 text-right">${this.formatCurrency(totalDaily)}</td>
                        <td class="p-2 text-right">${this.formatCurrency(finalUpToDate)}</td>
                    </tr>`;
                this.elements.historyTableBody.innerHTML += totalRow;
            },

            renderHistoryChart(reports, year, month) {
                const daysInMonth = new Date(year, month, 0).getDate();
                const labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
                
                const cumulativeSalesData = new Array(daysInMonth).fill(null);
                reports.forEach(report => {
                    const day = new Date(report.dateKey).getUTCDate();
                    cumulativeSalesData[day - 1] = report.newUpToDateSales;
                });
                
                for (let i = 1; i < cumulativeSalesData.length; i++) {
                    if (cumulativeSalesData[i] === null && cumulativeSalesData[i-1] !== null) {
                        cumulativeSalesData[i] = cumulativeSalesData[i - 1];
                    }
                }

                const configData = reports.length > 0 ? reports[reports.length-1] : this.getCurrentDataFromForm();
                const target = configData.monthlyTarget || 0;
                const baseline = configData.baselineTarget || 0;

                if (this.salesChartInstance) {
                    this.salesChartInstance.destroy();
                }
                const ctx = this.elements.salesChart.getContext('2d');
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
                gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');


                this.salesChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Cumulative Sales',
                                data: cumulativeSalesData,
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: gradient,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: 'rgb(59, 130, 246)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgb(59, 130, 246)',
                                borderWidth: 2.5,
                                pointRadius: 3,
                                pointHoverRadius: 6,
                            },
                            {
                                label: 'Target',
                                data: Array(daysInMonth).fill(target),
                                borderColor: 'rgb(22, 163, 74)',
                                borderDash: [5, 5],
                                pointRadius: 0,
                                fill: false,
                                borderWidth: 2,
                            },
                             {
                                label: 'Baseline',
                                data: Array(daysInMonth).fill(baseline),
                                borderColor: 'rgb(234, 179, 8)',
                                borderDash: [5, 5],
                                pointRadius: 0,
                                fill: false,
                                borderWidth: 2,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            intersect: false,
                            mode: 'index',
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: '#e5e7eb' },
                                ticks: { callback: (value) => `RM ${this.formatCurrency(value)}` }
                            },
                            x: { grid: { display: false } }
                        },
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: { callbacks: { label: (context) => `${context.dataset.label}: RM ${this.formatCurrency(context.parsed.y)}` } }
                        }
                    }
                });
            },

            hideModal() {
                 this.elements.historyModal.classList.add('opacity-0');
                 setTimeout(() => this.elements.historyModal.classList.add('hidden'), 300);
            },

            showToast(message, isSuccess = true) {
                this.elements.toastMessage.textContent = message;
                this.elements.toast.className = 'toast fixed bottom-5 right-5 py-2 px-4 rounded-lg shadow-lg';
                this.elements.toast.classList.add(isSuccess ? 'bg-green-600' : 'bg-red-600', 'text-white');
                this.elements.toast.classList.remove('opacity-0', 'translate-y-10');
                setTimeout(() => this.elements.toast.classList.add('opacity-0', 'translate-y-10'), 3000);
            },

            showError(message) {
                this.elements.container.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert"><strong class="font-bold">Application Error!</strong><span class="block sm:inline">${message}</span></div>`;
            },

            formatDate(date) {
                const [year, month, day] = [date.getFullYear(), String(date.getMonth() + 1).padStart(2, '0'), String(date.getDate()).padStart(2, '0')];
                return `${year}-${month}-${day}`;
            },

            formatCurrency(value, withPrefix = false) {
                const formatted = (value || 0).toLocaleString('ms-MY', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                return withPrefix ? `RM ${formatted}` : formatted;
            },

            async init() {
                const isFirebaseReady = await this.initFirebase();
                if (isFirebaseReady) {
                    this.bindEvents();
                    this.elements.salesDate.value = this.formatDate(new Date());
                    this.updateDateFields();
                    await this.loadDataForDate(this.elements.salesDate.value);
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            SalesApp.init();
        });

    </script>

</body>
</html>

