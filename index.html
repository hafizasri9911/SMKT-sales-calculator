<!DOCTYPE html>
<html lang="en" class=""> <!-- Default to light mode, class 'dark' will be added here -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Report Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s, color 0.3s;
        }
        /* Chart.js dark mode adjustments */
        .dark .chartjs-tooltip {
            background: rgba(31, 41, 55, 0.8) !important; /* gray-800 with opacity */
            color: #f3f4f6 !important; /* gray-100 */
        }
        .dark .chartjs-tooltip-key {
            border-color: rgba(255, 255, 255, 0.8) !important;
        }
        .dark #salesChart, .dark #categoryPieChart {
             background-color: #374151; /* gray-700 for chart background */
        }
        
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; color: #4A5568; font-weight: 500; }
        .dark .input-group label { color: #d1d5db; } /* gray-300 */

        .input-group input, .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #E2E8F0; /* gray-200 */
            border-radius: 0.5rem;
            transition: border-color 0.2s, background-color 0.3s, color 0.3s;
            background-color: #fff; /* white */
            color: #1f2937; /* gray-800 */
        }
        .dark .input-group input, .dark .input-group textarea {
            background-color: #374151; /* gray-700 */
            border-color: #4b5563; /* gray-600 */
            color: #f3f4f6; /* gray-100 */
        }
         .input-group input::placeholder, .input-group textarea::placeholder {
             color: #9ca3af; /* gray-400 */
         }
         .dark .input-group input::placeholder, .dark .input-group textarea::placeholder {
             color: #6b7280; /* gray-500 */
         }


        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: #4299E1; /* blue-500 */
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.5);
        }
         .dark .input-group input:focus, .dark .input-group textarea:focus {
            border-color: #60a5fa; /* blue-400 */
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.5);
        }
        
         .input-group input[readonly] {
             background-color: #f3f4f6; /* gray-100 */
             cursor: not-allowed;
         }
         .dark .input-group input[readonly] {
             background-color: #4b5563; /* gray-600 */
         }


        .generated-text {
            white-space: pre-wrap;
            background-color: #edf2f7; /* gray-100 */
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: monospace;
            color: #2d3748; /* gray-800 */
            border: 1px solid #e2e8f0; /* gray-200 */
            min-height: 200px;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
         .dark .generated-text {
            background-color: #1f2937; /* gray-800 */
            color: #d1d5db; /* gray-300 */
            border-color: #4b5563; /* gray-600 */
        }

        .modal { transition: opacity 0.3s ease; }
        .toast { transition: opacity 0.5s, transform 0.5s; }
        
        .kpi-card {
            background-color: #f8fafc; /* slate-50 */
            border: 1px solid #e2e8f0; /* slate-200 */
            border-left: 4px solid #e2e8f0; /* Default border */
            border-radius: 0.75rem;
            padding: 1rem;
            transition: border-color 0.3s ease, background-color 0.3s;
        }
         .dark .kpi-card {
            background-color: #1f2937; /* gray-800 */
            border-color: #4b5563; /* gray-600 */
             border-left-color: #4b5563; /* Default border dark */
         }
        .kpi-card.blue { border-left-color: rgb(59, 130, 246); }
        .kpi-card.orange { border-left-color: rgb(249, 115, 22); }
        .kpi-card.red { border-left-color: rgb(220, 38, 38); }
        .dark .kpi-card.blue { border-left-color: rgb(96, 165, 250); } /* blue-400 */
        .dark .kpi-card.orange { border-left-color: rgb(251, 146, 60); } /* orange-400 */
        .dark .kpi-card.red { border-left-color: rgb(248, 113, 113); } /* red-400 */


        .status-indicator {
            font-size: 0.75rem;
            color: #64748b; /* slate-500 */
            transition: opacity 0.5s;
        }
         .dark .status-indicator {
             color: #94a3b8; /* slate-400 */
         }
         
        /* History Modal Styling */
        .dark #historyModal .bg-white { background-color: #111827; } /* gray-900 */
        .dark #historyModal .border-b { border-color: #374151; } /* gray-700 */
        .dark #historyModal h2, .dark #historyModal h3 { color: #f3f4f6; } /* gray-100 */
        .dark #historyModal input[type="month"] { background-color: #374151; border-color: #4b5563; color: #f3f4f6; }
        .dark #historyModal .bg-gray-50 { background-color: #1f2937; } /* gray-800 */
        .dark #historyModal .bg-gray-100 { background-color: #374151; } /* gray-700 */
        .dark #historyModal table th { color: #d1d5db; } /* gray-300 */
        .dark #historyModal table td { color: #9ca3af; } /* gray-400 */
         .dark #historyModal table .font-bold { color: #e5e7eb; } /* gray-200 */
        .dark #historyModal .border-b { border-color: #374151; } /* gray-700 */
        .dark #historyModal .bg-gray-200 { background-color: #4b5563; } /* gray-600 */
        .dark #historyModal .border-gray-400 { border-color: #6b7280; } /* gray-500 */
        .dark #historyModal .text-red-500 { color: #f87171; } /* red-400 */

        /* Tailwind utility override for dark scrollbar */
         .dark ::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* gray-600 */
            border-radius: 10px;
            border: 3px solid #1f2937; /* gray-800 */
        }
        .dark ::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
            border-radius: 10px;
        }
         ::-webkit-scrollbar { width: 12px; }
         ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px;} /* slate-100 */
         ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; border: 3px solid #f1f5f9; } /* slate-300, slate-100 */
         ::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; } /* slate-400 */
         
    </style>
    <script>
      // Apply theme on initial load
      if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark')
      } else {
        document.documentElement.classList.remove('dark')
      }
      // Tailwind config for dark mode
      tailwind.config = {
        darkMode: 'class', // Use class strategy
      }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-8xl relative">
       <!-- Dark Mode Toggle Button -->
        <button id="theme-toggle" type="button" class="absolute top-4 right-4 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5">
            <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
            <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 011.414 0l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 011.414 0l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
        </button>

        <div class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg">
            
            <header class="mb-8 text-center">
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Sales Report Calculator</h1>
                 <p class="text-gray-500 dark:text-gray-400 mt-2">data is now saved online and accessible from any device. <span id="save-status" class="status-indicator ml-2"></span></p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Input Section -->
                <div class="space-y-4">
                    <div class="input-group">
                        <label for="shopName">Company / Branch Name</label>
                        <input type="text" id="shopName" value="SMKT" placeholder="E.g., SMKT">
                    </div>
                    
                    <div class="input-group">
                        <label for="salesDate">Sales Date</label>
                        <input type="date" id="salesDate">
                    </div>

                    <div class="input-group">
                        <label for="monthlyTarget">Monthly Sales Target (RM)</label>
                        <input type="number" id="monthlyTarget" placeholder="E.g., 492000.00" step="0.01">
                    </div>

                    <div class="input-group">
                        <label for="baselineTarget">Baseline (RM)</label>
                        <input type="number" id="baselineTarget" placeholder="E.g., 200000.00" step="0.01">
                    </div>

                    <div class="input-group">
                        <label for="upToDateSales">Up to Date Sales (Before Today) (RM)</label>
                        <input type="number" id="upToDateSales" placeholder="Calculated automatically" readonly class="bg-gray-100 dark:bg-gray-600">
                    </div>
                    
                    <div class="input-group">
                        <label for="coreProduct">Core Product Sales (RM)</label>
                        <input type="number" id="coreProduct" placeholder="E.g., 17795.00" step="0.01">
                        <textarea id="coreProductItems" class="mt-2" rows="15" placeholder="Item list (one per line)..."></textarea>
                    </div>

                    <div class="input-group">
                        <label for="accessories">Accessories Sales (RM)</label>
                        <input type="number" id="accessories" placeholder="E.g., 227.00" step="0.01">
                        <textarea id="accessoriesItems" class="mt-2" rows="15" placeholder="Item list (one per line)..."></textarea>
                    </div>

                    <div class="input-group">
                        <label for="warranty">Warranty Sales (RM)</label>
                        <input type="number" id="warranty" placeholder="E.g., 17795.00" step="0.01">
                        <textarea id="warrantyItems" class="mt-2" rows="7" placeholder="Item list (one per line)..."></textarea>
                    </div>

                    <div class="input-group">
                        <label for="tradeIn">Trade In Sales (RM)</label>
                        <input type="number" id="tradeIn" placeholder="E.g., 17795.00" step="0.01">
                        <textarea id="tradeInItems" class="mt-2" rows="7" placeholder="Item list (one per line)..."></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="input-group">
                            <label for="currentDay">Day</label>
                            <input type="number" id="currentDay" placeholder="Auto" readonly class="bg-gray-100 dark:bg-gray-600">
                        </div>
                        <div class="input-group">
                            <label for="totalDays">Total Days</label>
                            <input type="number" id="totalDays" placeholder="Auto" readonly class="bg-gray-100 dark:bg-gray-600">
                        </div>
                    </div>
                    
                    <button id="saveBtn" class="w-full bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-md">
                        Save Report
                    </button>
                    <button id="historyBtn" class="w-full bg-gray-600 hover:bg-gray-700 dark:bg-gray-500 dark:hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-md">
                        View History
                    </button>
                </div>
                
                <!-- Output Section -->
                <div>
                    <label class="block mb-2 font-medium text-gray-700 dark:text-gray-300">Generated Report (Live Preview)</label>
                    <div id="output" class="generated-text">The report will be displayed here...</div>
                    <button id="copyBtn" class="mt-4 w-full bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-md">
                        Copy Text
                    </button>
                </div>
            </div>
        </div>
        <footer class="text-center mt-6 text-sm text-gray-400 dark:text-gray-500">
            <p>&copy; 2025 Created for Samsung KTCC Mall (Terengganu).</p>
        </footer>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <!-- Modal content -->
        <div class="bg-white dark:bg-gray-900 rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col">
             <!-- Modal header -->
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h2 class="text-xl font-bold dark:text-white">Monthly Sales Dashboard</h2>
                <input type="month" id="historyMonth" class="p-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                <button id="closeModalBtn" class="text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white text-3xl">&times;</button>
            </div>
             <!-- Modal body -->
            <div class="p-4 overflow-y-auto space-y-6">
                <!-- KPI & Pie Chart Row -->
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- KPI Cards -->
                    <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 text-center">
                         <div class="kpi-card">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Total Sales</p>
                            <p id="kpi-total-sales" class="text-2xl font-bold text-blue-600 dark:text-blue-400">RM 0.00</p>
                        </div>
                        <div class="kpi-card">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Remaining to Baseline</p>
                            <p id="kpi-remaining-baseline" class="text-2xl font-bold dark:text-white">RM 0.00</p>
                        </div>
                        <div class="kpi-card">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Remaining to Target</p>
                            <p id="kpi-remaining-target" class="text-2xl font-bold dark:text-white">RM 0.00</p>
                        </div>
                        <div class="kpi-card">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Average Daily Sales</p>
                            <p id="kpi-avg-daily" class="text-2xl font-bold text-gray-700 dark:text-gray-300">RM 0.00</p>
                        </div>
                        <div class="kpi-card">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Required Daily Average</p>
                            <p id="kpi-required-avg" class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">RM 0.00</p>
                        </div>
                    </div>
                     <!-- Pie Chart -->
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg flex flex-col items-center justify-center">
                        <h3 class="text-lg font-semibold mb-2 text-center dark:text-white">Category Contribution</h3>
                         <div style="max-width: 250px; max-height: 250px;">
                            <canvas id="categoryPieChart"></canvas>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-2 dark:text-white">Sales Flow</h3>
                    <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded-lg">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2 dark:text-white">Daily Breakdown</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100 dark:bg-gray-700">
                                <tr>
                                    <th class="p-2 dark:text-gray-300">Date</th>
                                    <th class="p-2 text-right dark:text-gray-300">Core (RM)</th>
                                    <th class="p-2 text-right dark:text-gray-300">Acc. (RM)</th>
                                    <th class="p-2 text-right dark:text-gray-300">War. (RM)</th>
                                    <th class="p-2 text-right dark:text-gray-300">TradeIn (RM)</th>
                                    <th class="p-2 text-right font-bold dark:text-gray-300">Daily (RM)</th>
                                    <th class="p-2 text-right font-bold dark:text-gray-300">Up to Date (RM)</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody" class="dark:text-gray-400"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-10">
        <p id="toast-message"></p>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const SalesApp = {
            db: null,
            auth: null,
            appId: 'sales-calculator-app',
            allReports: [],
            salesChartInstance: null,
            categoryPieChartInstance: null,
            autoSaveTimeout: null, // Timer for auto-save

            elements: {
                html: document.documentElement,
                themeToggleBtn: document.getElementById('theme-toggle'),
                themeToggleDarkIcon: document.getElementById('theme-toggle-dark-icon'),
                themeToggleLightIcon: document.getElementById('theme-toggle-light-icon'),
                container: document.getElementById('app-container'),
                salesDate: document.getElementById('salesDate'),
                saveBtn: document.getElementById('saveBtn'),
                copyBtn: document.getElementById('copyBtn'),
                historyBtn: document.getElementById('historyBtn'),
                historyModal: document.getElementById('historyModal'),
                closeModalBtn: document.getElementById('closeModalBtn'),
                historyMonth: document.getElementById('historyMonth'),
                salesChart: document.getElementById('salesChart'),
                categoryPieChart: document.getElementById('categoryPieChart'),
                historyTableBody: document.getElementById('historyTableBody'),
                toast: document.getElementById('toast'),
                toastMessage: document.getElementById('toast-message'),
                output: document.getElementById('output'),
                shopName: document.getElementById('shopName'),
                monthlyTarget: document.getElementById('monthlyTarget'),
                baselineTarget: document.getElementById('baselineTarget'),
                upToDateSales: document.getElementById('upToDateSales'),
                coreProduct: document.getElementById('coreProduct'),
                coreProductItems: document.getElementById('coreProductItems'),
                accessories: document.getElementById('accessories'),
                accessoriesItems: document.getElementById('accessoriesItems'),
                warranty: document.getElementById('warranty'),
                warrantyItems: document.getElementById('warrantyItems'),
                tradeIn: document.getElementById('tradeIn'),
                tradeInItems: document.getElementById('tradeInItems'),
                currentDay: document.getElementById('currentDay'),
                totalDays: document.getElementById('totalDays'),
                kpiTotalSales: document.getElementById('kpi-total-sales'),
                kpiRemainingBaseline: document.getElementById('kpi-remaining-baseline'),
                kpiRemainingTarget: document.getElementById('kpi-remaining-target'),
                kpiAvgDaily: document.getElementById('kpi-avg-daily'),
                kpiRequiredAvg: document.getElementById('kpi-required-avg'),
                saveStatus: document.getElementById('save-status'), // Save status indicator
            },

            async initFirebase() {
                try {
                    const firebaseConfig = {
                        apiKey: "AIzaSyCWR7vfKgtNZrXutLmdd0163EhMUrLkBQA",
                        authDomain: "sales-report-app-ab55e.firebaseapp.com",
                        projectId: "sales-report-app-ab55e",
                        storageBucket: "sales-report-app-ab55e.appspot.com",
                        messagingSenderId: "357226489797",
                        appId: "1:357226489797:web:7beee72678971a468b8dac",
                        measurementId: "G-03PBVT3BDX"
                    };
                    const app = initializeApp(firebaseConfig);
                    this.db = getFirestore(app);
                    this.auth = getAuth(app);
                    await signInAnonymously(this.auth);
                    return true;
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    this.showError(`Database Connection Error! Details: ${error.message}`);
                    return false;
                }
            },

            // Debounce function
            debounce(func, delay) {
                clearTimeout(this.autoSaveTimeout);
                this.autoSaveTimeout = setTimeout(func, delay);
            },
            
            // --- Theme Toggle Logic ---
            initThemeToggle() {
                 // Function to update icon visibility
                const updateIcons = () => {
                    if (this.elements.html.classList.contains('dark')) {
                        this.elements.themeToggleLightIcon.classList.remove('hidden');
                        this.elements.themeToggleDarkIcon.classList.add('hidden');
                    } else {
                        this.elements.themeToggleLightIcon.classList.add('hidden');
                        this.elements.themeToggleDarkIcon.classList.remove('hidden');
                    }
                };

                 // Initial icon state
                 updateIcons();

                 // Toggle logic
                 this.elements.themeToggleBtn.addEventListener('click', () => {
                    // toggle class on html tag
                    this.elements.html.classList.toggle('dark');
                    // save preference to local storage
                    if (this.elements.html.classList.contains('dark')) {
                        localStorage.theme = 'dark';
                    } else {
                        localStorage.theme = 'light';
                    }
                     updateIcons(); // Update icons after toggle
                     
                     // If history modal is open, redraw charts with updated theme colors
                     if (!this.elements.historyModal.classList.contains('hidden')) {
                         this.updateHistoryDashboard(); 
                     }
                });
            },
            // --- End Theme Toggle Logic ---

            bindEvents() {
                this.initThemeToggle(); // Initialize the theme toggle

                this.elements.salesDate.addEventListener('change', () => {
                    this.updateDateFields();
                    this.loadDataForDate(this.elements.salesDate.value);
                });
                
                const inputsToTrack = ['shopName', 'monthlyTarget', 'baselineTarget', 'coreProduct', 'coreProductItems', 'accessories', 'accessoriesItems', 'warranty', 'warrantyItems', 'tradeIn', 'tradeInItems'];
                
                // Attach live update and auto-save listeners
                inputsToTrack.forEach(id => {
                    const element = this.elements[id];
                    if (element) {
                        element.addEventListener('input', () => {
                            this.liveUpdateReport(); 
                            this.indicateSaving(); // Show "Saving..."
                            this.debounce(() => this.autoSaveReport(), 2000); // Auto-save after 2 seconds of inactivity
                        });
                    }
                });

                this.elements.saveBtn.addEventListener('click', () => this.saveReport()); // Manual save
                this.elements.copyBtn.addEventListener('click', () => this.copyReport());
                this.elements.historyBtn.addEventListener('click', () => this.showHistory());
                this.elements.closeModalBtn.addEventListener('click', () => this.hideModal());
                this.elements.historyModal.addEventListener('click', (e) => {
                    if (e.target === this.elements.historyModal) this.hideModal();
                });
                this.elements.historyMonth.addEventListener('change', () => this.updateHistoryDashboard());
            },

            getCurrentDataFromForm() {
                const data = {
                    shopName: this.elements.shopName.value,
                    monthlyTarget: parseFloat(this.elements.monthlyTarget.value) || 0,
                    baselineTarget: parseFloat(this.elements.baselineTarget.value) || 0,
                    previousUpToDateSales: parseFloat(this.elements.upToDateSales.value) || 0,
                    coreProductSales: parseFloat(this.elements.coreProduct.value) || 0,
                    accessoriesSales: parseFloat(this.elements.accessories.value) || 0,
                    warrantySales: parseFloat(this.elements.warranty.value) || 0,
                    tradeInSales: parseFloat(this.elements.tradeIn.value) || 0,
                    coreProductItems: this.elements.coreProductItems.value.trim(),
                    accessoriesItems: this.elements.accessoriesItems.value.trim(),
                    warrantyItems: this.elements.warrantyItems.value.trim(),
                    tradeInItems: this.elements.tradeInItems.value.trim(),
                    dateKey: this.elements.salesDate.value
                };
                const dailySales = data.coreProductSales + data.accessoriesSales + data.warrantySales + data.tradeInSales;
                data.newUpToDateSales = data.previousUpToDateSales + dailySales;
                return data;
            },
            
            liveUpdateReport() {
                const data = this.getCurrentDataFromForm();
                this.generateReport(data);
            },
             
            async autoSaveReport() {
                await this.saveReport(true); // Pass true to indicate auto-save
            },

            async saveReport(isAutoSave = false) {
                const data = this.getCurrentDataFromForm();
                try {
                    const reportRef = doc(this.db, `artifacts/${this.appId}/public/data/salesReports/${data.dateKey}`);
                    await setDoc(reportRef, data);

                    const configRef = doc(this.db, `artifacts/${this.appId}/public/data/salesConfig/config`);
                    await setDoc(configRef, { 
                        shopName: data.shopName, 
                        monthlyTarget: data.monthlyTarget,
                        baselineTarget: data.baselineTarget
                    }, { merge: true });

                    this.indicateSaved(); // Show "Saved!"
                    if (!isAutoSave) {
                        this.showToast("Report saved successfully!");
                    }
                } catch (error) {
                    console.error("Error saving data:", error);
                    this.indicateSaveError(); // Show save error
                     if (!isAutoSave) {
                        this.showToast("Failed to save report.", false);
                    }
                }
            },
            
            // --- Save Status Indicators ---
            indicateSaving() {
                this.elements.saveStatus.textContent = '(Saving...)';
                this.elements.saveStatus.style.opacity = '1';
                this.elements.saveStatus.style.color = document.documentElement.classList.contains('dark') ? '#9ca3af' : '#64748b'; // Adjust color for dark/light
            },
            indicateSaved() {
                this.elements.saveStatus.textContent = '(Saved)';
                this.elements.saveStatus.style.opacity = '1';
                this.elements.saveStatus.style.color = document.documentElement.classList.contains('dark') ? '#34d399' : '#16a34a'; // Adjust color for dark/light
                 setTimeout(() => { this.elements.saveStatus.style.opacity = '0'; }, 3000);
            },
             indicateSaveError() {
                this.elements.saveStatus.textContent = '(Save Error!)';
                this.elements.saveStatus.style.opacity = '1';
                 this.elements.saveStatus.style.color = document.documentElement.classList.contains('dark') ? '#f87171' : '#dc2626'; // Adjust color for dark/light
            },
            // --- End Save Status Indicators ---

            generateReport(data) {
                const [year, month, day] = data.dateKey.split('-').map(Number);
                const currentDay = day;
                const totalDays = new Date(year, month, 0).getDate();
                
                const dailySales = data.coreProductSales + data.accessoriesSales + data.warrantySales + data.tradeInSales;
                const upToDatePercent = data.monthlyTarget > 0 ? (data.newUpToDateSales / data.monthlyTarget) * 100 : 0;
                const estimatedClosing = currentDay > 0 ? (data.newUpToDateSales / currentDay) * totalDays : 0;
                const estimatedClosingPercent = data.monthlyTarget > 0 ? (estimatedClosing / data.monthlyTarget) * 100 : 0;
                
                const formattedDisplayDate = `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;

                let indicator = '';
                if (data.monthlyTarget > 0 && data.newUpToDateSales >= data.monthlyTarget) {
                    indicator = 'Target Achieved! ðŸŽ‰';
                } else if (data.baselineTarget > 0 && data.newUpToDateSales >= data.baselineTarget) {
                    indicator = 'Baseline Achieved! ðŸ‘';
                }

                const breakdownParts = [];
                const categories = [
                    { title: 'Core Product', sales: data.coreProductSales, items: data.coreProductItems },
                    { title: 'Accessories', sales: data.accessoriesSales, items: data.accessoriesItems },
                    { title: 'Warranty', sales: data.warrantySales, items: data.warrantyItems },
                    { title: 'Trade In', sales: data.tradeInSales, items: data.tradeInItems },
                ];

                categories.forEach(cat => {
                    if (cat.sales > 0 || (cat.items && cat.items.length > 0)) {
                        let part = `${cat.title} : RM ${this.formatCurrency(cat.sales)}`;
                        if (cat.items) {
                            part += `\n${cat.items.split('\n').map(item => item.trim()).join('\n')}`;
                        }
                        breakdownParts.push(part);
                    }
                });
                
                const salesBreakdown = breakdownParts.join('\n\n');
                const indicatorLine = indicator ? `${indicator}\n` : '';

                const outputText = 
`${data.shopName.toUpperCase()} ${formattedDisplayDate} Sales : RM ${this.formatCurrency(dailySales)}

${salesBreakdown}

Target : RM ${this.formatCurrency(data.monthlyTarget)}
Up to Date : RM ${this.formatCurrency(data.newUpToDateSales)} (${upToDatePercent.toFixed(0)}%)
${indicatorLine}Estimated Closing : RM ${this.formatCurrency(estimatedClosing)} (${estimatedClosingPercent.toFixed(0)}%)`;

                this.elements.output.textContent = outputText;
            },
            
            async loadDataForDate(dateKey) {
                try {
                    const configRef = doc(this.db, `artifacts/${this.appId}/public/data/salesConfig/config`);
                    const configSnap = await getDoc(configRef);
                    if (configSnap.exists()) {
                        const config = configSnap.data();
                        this.elements.shopName.value = config.shopName || 'SMKT';
                        this.elements.monthlyTarget.value = config.monthlyTarget || '';
                        this.elements.baselineTarget.value = config.baselineTarget || '';
                    }

                    const reportRef = doc(this.db, `artifacts/${this.appId}/public/data/salesReports/${dateKey}`);
                    const reportSnap = await getDoc(reportRef);

                    if (reportSnap.exists()) {
                        const data = reportSnap.data();
                        this.elements.shopName.value = data.shopName || this.elements.shopName.value;
                        this.elements.monthlyTarget.value = data.monthlyTarget || this.elements.monthlyTarget.value;
                        this.elements.baselineTarget.value = data.baselineTarget || this.elements.baselineTarget.value;
                        this.elements.upToDateSales.value = (data.previousUpToDateSales || 0).toFixed(2);
                        this.elements.coreProduct.value = data.coreProductSales || '';
                        this.elements.coreProductItems.value = data.coreProductItems || '';
                        this.elements.accessories.value = data.accessoriesSales || '';
                        this.elements.accessoriesItems.value = data.accessoriesItems || '';
                        this.elements.warranty.value = data.warrantySales || '';
                        this.elements.warrantyItems.value = data.warrantyItems || '';
                        this.elements.tradeIn.value = data.tradeInSales || '';
                        this.elements.tradeInItems.value = data.tradeInItems || '';
                    } else {
                        this.resetDailyInputs();
                        const [year, month, day] = dateKey.split('-').map(Number);
                        
                        if (day === 1) {
                            this.elements.upToDateSales.value = (0).toFixed(2);
                        } else {
                            const selectedDate = new Date(year, month - 1, day);
                            const yesterday = new Date(selectedDate);
                            yesterday.setDate(selectedDate.getDate() - 1);
                            const yesterdayKey = this.formatDate(yesterday);
                            const yesterdayRef = doc(this.db, `artifacts/${this.appId}/public/data/salesReports/${yesterdayKey}`);
                            const yesterdaySnap = await getDoc(yesterdayRef);
                            
                            let prevSales = 0;
                            if (yesterdaySnap.exists() && yesterday.getMonth() === selectedDate.getMonth()) {
                                prevSales = yesterdaySnap.data().newUpToDateSales || 0;
                            }
                            this.elements.upToDateSales.value = prevSales.toFixed(2);
                        }
                    }
                    this.liveUpdateReport();
                } catch (error) {
                    console.error("Error loading data:", error);
                }
            },

            resetDailyInputs() {
                ['coreProduct', 'coreProductItems', 'accessories', 'accessoriesItems', 'warranty', 'warrantyItems', 'tradeIn', 'tradeInItems'].forEach(id => {
                    this.elements[id].value = '';
                });
            },

            updateDateFields() {
                const dateValue = this.elements.salesDate.value;
                if (dateValue) {
                    const [year, month, day] = dateValue.split('-').map(Number);
                    this.elements.currentDay.value = day;
                    this.elements.totalDays.value = new Date(year, month, 0).getDate();
                }
            },
            
            copyReport() {
                navigator.clipboard.writeText(this.elements.output.textContent).then(() => {
                    this.showToast("Report copied to clipboard!");
                });
            },

            async showHistory() {
                this.elements.historyModal.classList.remove('hidden');
                setTimeout(() => this.elements.historyModal.classList.remove('opacity-0'), 10);
                this.elements.historyTableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4">Loading history...</td></tr>';
                
                try {
                    const reportsCol = collection(this.db, `artifacts/${this.appId}/public/data/salesReports`);
                    const querySnapshot = await getDocs(query(reportsCol));
                    this.allReports = [];
                    querySnapshot.forEach(doc => this.allReports.push(doc.data()));
                    this.allReports.sort((a, b) => new Date(a.dateKey) - new Date(b.dateKey));
                    
                    const today = new Date();
                    this.elements.historyMonth.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                    this.updateHistoryDashboard();

                } catch(error) {
                    console.error("Error fetching history: ", error);
                    this.elements.historyTableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-red-500 dark:text-red-400">Could not load history.</td></tr>';
                }
            },
            
            updateHistoryDashboard() {
                const [year, month] = this.elements.historyMonth.value.split('-').map(Number);
                const filteredReports = this.allReports.filter(r => {
                    const [rYear, rMonth] = r.dateKey.split('-').map(Number);
                    return rYear === year && rMonth === month;
                });

                this.renderHistoryTable(filteredReports);
                this.renderHistoryChart(filteredReports, year, month);
                this.updateKpiCards(filteredReports, year, month);
                this.renderCategoryPieChart(filteredReports);
            },

            updateKpiCards(reports, year, month) {
                const kpiBaselineCard = this.elements.kpiRemainingBaseline.parentElement;
                const kpiTargetCard = this.elements.kpiRemainingTarget.parentElement;
                
                [kpiBaselineCard, kpiTargetCard].forEach(card => card.classList.remove('blue', 'orange', 'red'));

                if(reports.length === 0) {
                    this.elements.kpiTotalSales.textContent = this.formatCurrency(0, true);
                    this.elements.kpiRemainingBaseline.textContent = this.formatCurrency(parseFloat(this.elements.baselineTarget.value) || 0, true);
                    this.elements.kpiRemainingTarget.textContent = this.formatCurrency(parseFloat(this.elements.monthlyTarget.value) || 0, true);
                    this.elements.kpiAvgDaily.textContent = this.formatCurrency(0, true);
                    this.elements.kpiRequiredAvg.textContent = this.formatCurrency(0, true);
                    kpiBaselineCard.classList.add('red');
                    kpiTargetCard.classList.add('red');
                    return;
                }

                const latestReport = reports[reports.length - 1];
                const totalSales = latestReport.newUpToDateSales || 0;
                const target = latestReport.monthlyTarget || 0;
                const baseline = latestReport.baselineTarget || 0;

                const remainingToTarget = Math.max(0, target - totalSales);
                const remainingToBaseline = Math.max(0, baseline - totalSales);
                
                const totalDailySales = reports.reduce((sum, r) => sum + ((r.coreProductSales || 0) + (r.accessoriesSales || 0) + (r.warrantySales || 0) + (r.tradeInSales || 0)), 0);
                const averageDailySales = reports.length > 0 ? totalDailySales / reports.length : 0;
                
                const totalDaysInMonth = new Date(year, month, 0).getDate();
                const lastDayRecorded = new Date(latestReport.dateKey).getUTCDate();
                const daysRemaining = totalDaysInMonth - lastDayRecorded;
                let requiredDailyAverage = 0;
                if (remainingToTarget > 0 && daysRemaining > 0) {
                    requiredDailyAverage = remainingToTarget / daysRemaining;
                }

                this.elements.kpiTotalSales.textContent = this.formatCurrency(totalSales, true);
                this.elements.kpiRemainingBaseline.textContent = this.formatCurrency(remainingToBaseline, true);
                this.elements.kpiRemainingTarget.textContent = this.formatCurrency(remainingToTarget, true);
                this.elements.kpiAvgDaily.textContent = this.formatCurrency(averageDailySales, true);
                this.elements.kpiRequiredAvg.textContent = this.formatCurrency(requiredDailyAverage, true);
                
                if (baseline > 0) {
                    if (totalSales >= baseline) kpiBaselineCard.classList.add('blue');
                    else if (totalSales >= baseline * 0.8) kpiBaselineCard.classList.add('orange');
                    else kpiBaselineCard.classList.add('red');
                }

                if (target > 0) {
                    if (totalSales >= target) kpiTargetCard.classList.add('blue');
                    else if (totalSales >= target * 0.8) kpiTargetCard.classList.add('orange');
                    else kpiTargetCard.classList.add('red');
                }
            },
            
            renderHistoryTable(reports) {
                this.elements.historyTableBody.innerHTML = ''; 
                if (reports.length === 0) {
                    this.elements.historyTableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4">No data for this month.</td></tr>';
                    return;
                }
                
                let totalCore = 0, totalAcc = 0, totalWar = 0, totalTradeIn = 0, totalDaily = 0;

                reports.forEach(report => {
                    const [year, month, day] = report.dateKey.split('-').map(Number);
                    const displayDate = `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
                    const dailySales = (report.coreProductSales || 0) + (report.accessoriesSales || 0) + (report.warrantySales || 0) + (report.tradeInSales || 0);
                    
                    totalCore += report.coreProductSales || 0;
                    totalAcc += report.accessoriesSales || 0;
                    totalWar += report.warrantySales || 0;
                    totalTradeIn += report.tradeInSales || 0;
                    totalDaily += dailySales;

                    const row = `
                        <tr class="border-b dark:border-gray-700">
                            <td class="p-2">${displayDate}</td>
                            <td class="p-2 text-right">${this.formatCurrency(report.coreProductSales)}</td>
                            <td class="p-2 text-right">${this.formatCurrency(report.accessoriesSales)}</td>
                            <td class="p-2 text-right">${this.formatCurrency(report.warrantySales)}</td>
                            <td class="p-2 text-right">${this.formatCurrency(report.tradeInSales)}</td>
                            <td class="p-2 text-right font-bold">${this.formatCurrency(dailySales)}</td>
                            <td class="p-2 text-right font-bold">${this.formatCurrency(report.newUpToDateSales)}</td>
                        </tr>`;
                    this.elements.historyTableBody.innerHTML += row;
                });

                const finalUpToDate = reports.length > 0 ? reports[reports.length - 1].newUpToDateSales : 0;
                const totalRow = `
                    <tr class="bg-gray-200 dark:bg-gray-600 dark:text-gray-100 font-bold border-t-2 border-gray-400 dark:border-gray-500">
                        <td class="p-2">Total</td>
                        <td class="p-2 text-right">${this.formatCurrency(totalCore)}</td>
                        <td class="p-2 text-right">${this.formatCurrency(totalAcc)}</td>
                        <td class="p-2 text-right">${this.formatCurrency(totalWar)}</td>
                        <td class="p-2 text-right">${this.formatCurrency(totalTradeIn)}</td>
                        <td class="p-2 text-right">${this.formatCurrency(totalDaily)}</td>
                        <td class="p-2 text-right">${this.formatCurrency(finalUpToDate)}</td>
                    </tr>`;
                this.elements.historyTableBody.innerHTML += totalRow;
            },

            renderHistoryChart(reports, year, month) {
                 // Set Chart.js defaults based on theme
                 Chart.defaults.color = document.documentElement.classList.contains('dark') ? '#9ca3af' : '#6b7280'; // gray-400 / gray-500
                 Chart.defaults.borderColor = document.documentElement.classList.contains('dark') ? '#4b5563' : '#e5e7eb'; // gray-600 / gray-200


                const daysInMonth = new Date(year, month, 0).getDate();
                const labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
                
                const cumulativeSalesData = new Array(daysInMonth).fill(null);
                reports.forEach(report => {
                    const day = new Date(report.dateKey).getUTCDate();
                    cumulativeSalesData[day - 1] = report.newUpToDateSales;
                });
                
                for (let i = 1; i < cumulativeSalesData.length; i++) {
                    if (cumulativeSalesData[i] === null && cumulativeSalesData[i-1] !== null) {
                        cumulativeSalesData[i] = cumulativeSalesData[i - 1];
                    }
                }

                const configData = reports.length > 0 ? reports[reports.length-1] : this.getCurrentDataFromForm();
                const target = configData.monthlyTarget || 0;
                const baseline = configData.baselineTarget || 0;

                if (this.salesChartInstance) {
                    this.salesChartInstance.destroy();
                }
                const ctx = this.elements.salesChart.getContext('2d');
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                 if (document.documentElement.classList.contains('dark')) {
                     gradient.addColorStop(0, 'rgba(96, 165, 250, 0.5)'); // blue-400
                     gradient.addColorStop(1, 'rgba(96, 165, 250, 0)');
                 } else {
                    gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); // blue-500
                    gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
                 }


                this.salesChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Cumulative Sales',
                                data: cumulativeSalesData,
                                borderColor: document.documentElement.classList.contains('dark') ? 'rgb(96, 165, 250)' : 'rgb(59, 130, 246)',
                                backgroundColor: gradient,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: document.documentElement.classList.contains('dark') ? 'rgb(96, 165, 250)' : 'rgb(59, 130, 246)',
                                pointBorderColor: document.documentElement.classList.contains('dark') ? '#1f2937' : '#fff',
                                pointHoverBackgroundColor: document.documentElement.classList.contains('dark') ? '#1f2937' : '#fff',
                                pointHoverBorderColor: document.documentElement.classList.contains('dark') ? 'rgb(96, 165, 250)' : 'rgb(59, 130, 246)',
                                borderWidth: 2.5,
                                pointRadius: 3,
                                pointHoverRadius: 6,
                            },
                            {
                                label: 'Target',
                                data: Array(daysInMonth).fill(target),
                                borderColor: document.documentElement.classList.contains('dark') ? 'rgb(52, 211, 153)' : 'rgb(22, 163, 74)', // emerald-400 / green-600
                                borderDash: [5, 5],
                                pointRadius: 0,
                                fill: false,
                                borderWidth: 2,
                            },
                             {
                                label: 'Baseline',
                                data: Array(daysInMonth).fill(baseline),
                                borderColor: document.documentElement.classList.contains('dark') ? 'rgb(251, 191, 36)' : 'rgb(234, 179, 8)', // amber-400 / yellow-500
                                borderDash: [5, 5],
                                pointRadius: 0,
                                fill: false,
                                borderWidth: 2,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { intersect: false, mode: 'index', },
                        scales: {
                            y: { 
                                beginAtZero: true, 
                                grid: { color: document.documentElement.classList.contains('dark') ? '#4b5563' : '#e5e7eb' }, 
                                ticks: { 
                                    color: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#6b7280',
                                    callback: (value) => `RM ${this.formatCurrency(value)}` 
                                } 
                            },
                            x: { 
                                grid: { display: false },
                                ticks: { color: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#6b7280' } 
                            }
                        },
                        plugins: {
                            legend: { 
                                position: 'top',
                                labels: { color: document.documentElement.classList.contains('dark') ? '#d1d5db' : '#374151' } 
                            },
                            tooltip: { 
                                callbacks: { 
                                    label: (context) => `${context.dataset.label}: RM ${this.formatCurrency(context.parsed.y)}` 
                                },
                                backgroundColor: document.documentElement.classList.contains('dark') ? 'rgba(31, 41, 55, 0.8)' : 'rgba(17, 24, 39, 0.8)', // Adjust tooltip background for theme
                                titleColor: document.documentElement.classList.contains('dark') ? '#f3f4f6' : '#fff',
                                bodyColor: document.documentElement.classList.contains('dark') ? '#f3f4f6' : '#fff',
                            }
                        }
                    }
                });
            },

            renderCategoryPieChart(reports) {
                 if (this.categoryPieChartInstance) {
                    this.categoryPieChartInstance.destroy();
                }

                let totalCore = 0, totalAcc = 0, totalWar = 0, totalTradeIn = 0;
                 reports.forEach(report => {
                    totalCore += report.coreProductSales || 0;
                    totalAcc += report.accessoriesSales || 0;
                    totalWar += report.warrantySales || 0;
                    totalTradeIn += report.tradeInSales || 0;
                });
                
                const totalSalesAllCategories = totalCore + totalAcc + totalWar + totalTradeIn;

                const ctx = this.elements.categoryPieChart.getContext('2d');
                if (totalSalesAllCategories <= 0) {
                     ctx.clearRect(0, 0, this.elements.categoryPieChart.width, this.elements.categoryPieChart.height);
                     ctx.textAlign = 'center';
                     ctx.fillStyle = document.documentElement.classList.contains('dark') ? '#9ca3af' : '#6b7280'; // Adjust text color for theme
                     ctx.fillText('No sales data for pie chart', this.elements.categoryPieChart.width / 2, this.elements.categoryPieChart.height / 2);
                    return;
                }

                
                this.categoryPieChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Core Product', 'Accessories', 'Warranty', 'Trade In'],
                        datasets: [{
                            label: 'Sales Contribution',
                            data: [totalCore, totalAcc, totalWar, totalTradeIn],
                            backgroundColor: [
                                document.documentElement.classList.contains('dark') ? 'rgb(96, 165, 250)' : 'rgb(59, 130, 246)', // Blue
                                document.documentElement.classList.contains('dark') ? 'rgb(251, 191, 36)' : 'rgb(234, 179, 8)',  // Yellow
                                document.documentElement.classList.contains('dark') ? 'rgb(52, 211, 153)' : 'rgb(22, 163, 74)',  // Green
                                document.documentElement.classList.contains('dark') ? 'rgb(156, 163, 175)' : 'rgb(107, 114, 128)' // Gray
                            ],
                            hoverOffset: 8,
                            borderWidth: 0,
                        }]
                    },
                    options: {
                        responsive: true,
                         maintainAspectRatio: false,
                        cutout: '70%', 
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { 
                                    padding: 15, 
                                    color: document.documentElement.classList.contains('dark') ? '#d1d5db' : '#374151' // Adjust legend color
                                }
                            },
                             tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const percentage = totalSalesAllCategories > 0 ? ((value / totalSalesAllCategories) * 100).toFixed(1) : 0;
                                        return `${label}: RM ${this.formatCurrency(value)} (${percentage}%)`;
                                    }
                                },
                                backgroundColor: document.documentElement.classList.contains('dark') ? 'rgba(31, 41, 55, 0.8)' : 'rgba(17, 24, 39, 0.8)',
                                titleColor: document.documentElement.classList.contains('dark') ? '#f3f4f6' : '#fff',
                                bodyColor: document.documentElement.classList.contains('dark') ? '#f3f4f6' : '#fff',
                            }
                        }
                    }
                });
            },


            hideModal() {
                 this.elements.historyModal.classList.add('opacity-0');
                 setTimeout(() => this.elements.historyModal.classList.add('hidden'), 300);
            },

            showToast(message, isSuccess = true) {
                this.elements.toastMessage.textContent = message;
                this.elements.toast.className = 'toast fixed bottom-5 right-5 py-2 px-4 rounded-lg shadow-lg';
                 // Adjust toast colors for dark mode
                 const bgColor = isSuccess ? (document.documentElement.classList.contains('dark') ? 'bg-green-700' : 'bg-green-600') : (document.documentElement.classList.contains('dark') ? 'bg-red-700' : 'bg-red-600');
                 this.elements.toast.classList.add(bgColor, 'text-white');
                this.elements.toast.classList.remove('opacity-0', 'translate-y-10');
                setTimeout(() => this.elements.toast.classList.add('opacity-0', 'translate-y-10'), 3000);
            },

            showError(message) {
                 const errorDiv = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative dark:bg-red-900 dark:border-red-700 dark:text-red-300" role="alert"><strong class="font-bold">Application Error!</strong><span class="block sm:inline">${message}</span></div>`;
                 if (this.elements.container) {
                     this.elements.container.innerHTML = errorDiv;
                 } else {
                     document.body.innerHTML = errorDiv; // Fallback if container not found
                 }
            },

            formatDate(date) {
                const [year, month, day] = [date.getFullYear(), String(date.getMonth() + 1).padStart(2, '0'), String(date.getDate()).padStart(2, '0')];
                return `${year}-${month}-${day}`;
            },

            formatCurrency(value, withPrefix = false) {
                // Ensure value is treated as a number before formatting
                const numericValue = Number(value) || 0;
                const formatted = numericValue.toLocaleString('ms-MY', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                return withPrefix ? `RM ${formatted}` : formatted;
            },


            async init() {
                const isFirebaseReady = await this.initFirebase();
                if (isFirebaseReady) {
                    this.bindEvents();
                    this.elements.salesDate.value = this.formatDate(new Date());
                    this.updateDateFields();
                    await this.loadDataForDate(this.elements.salesDate.value);
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            SalesApp.init();
        });

    </script>

</body>
</html>

