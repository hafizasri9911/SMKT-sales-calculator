<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Report Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; color: #4A5568; font-weight: 500; }
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #E2E8F0;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
        }
        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: #4299E1;
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.5);
        }
        .generated-text {
            white-space: pre-wrap;
            background-color: #edf2f7;
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: monospace;
            color: #2d3748;
            border: 1px solid #e2e8f0;
            min-height: 200px;
        }
        .modal { transition: opacity 0.3s ease; }
        .toast { transition: opacity 0.5s, transform 0.5s; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-8xl">
        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            
            <header class="mb-8 text-center">
                <h1 class="text-3xl font-bold text-gray-900">Sales Report Calculator</h1>
                <p class="text-gray-500 mt-2">Your data is now saved online and accessible from any device.</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Input Section -->
                <div class="space-y-4">
                    <div class="input-group">
                        <label for="shopName">Company / Branch Name</label>
                        <input type="text" id="shopName" value="SMKT" placeholder="E.g., SMKT">
                    </div>
                    
                    <div class="input-group">
                        <label for="salesDate">Sales Date</label>
                        <input type="date" id="salesDate">
                    </div>

                    <div class="input-group">
                        <label for="monthlyTarget">Monthly Sales Target (RM)</label>
                        <input type="number" id="monthlyTarget" placeholder="E.g., 492000.00" step="0.01">
                    </div>

                    <div class="input-group">
                        <label for="upToDateSales">Up to Date Sales (Before Today) (RM)</label>
                        <input type="number" id="upToDateSales" placeholder="Calculated automatically" readonly class="bg-gray-100">
                    </div>
                    
                    <div class="input-group">
                        <label for="coreProduct">Core Product Sales (RM)</label>
                        <input type="number" id="coreProduct" placeholder="E.g., 17795.00" step="0.01">
                        <textarea id="coreProductItems" class="mt-2" rows="2" placeholder="Item list (one per line)..."></textarea>
                    </div>

                    <div class="input-group">
                        <label for="accessories">Accessories Sales (RM)</label>
                        <input type="number" id="accessories" placeholder="E.g., 227.00" step="0.01">
                        <textarea id="accessoriesItems" class="mt-2" rows="2" placeholder="Item list (one per line)..."></textarea>
                    </div>

                    <div class="input-group">
                        <label for="warranty">Warranty Sales (RM)</label>
                        <input type="number" id="warranty" placeholder="Fill if available" step="0.01">
                        <textarea id="warrantyItems" class="mt-2" rows="2" placeholder="Item list (one per line)..."></textarea>
                    </div>

                    <div class="input-group">
                        <label for="tradeIn">Trade In Sales (RM)</label>
                        <input type="number" id="tradeIn" placeholder="Fill if available" step="0.01">
                        <textarea id="tradeInItems" class="mt-2" rows="2" placeholder="Item list (one per line)..."></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="input-group">
                            <label for="currentDay">Day</label>
                            <input type="number" id="currentDay" placeholder="Auto" readonly class="bg-gray-100">
                        </div>
                        <div class="input-group">
                            <label for="totalDays">Total Days</label>
                            <input type="number" id="totalDays" placeholder="Auto" readonly class="bg-gray-100">
                        </div>
                    </div>
                    
                    <button id="calculateBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">
                        Calculate & Save Report
                    </button>
                    <button id="historyBtn" class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition duration-300 shadow-md">
                        View History
                    </button>
                </div>
                
                <!-- Output Section -->
                <div>
                    <label class="block mb-2 font-medium text-gray-700">Generated Report</label>
                    <div id="output" class="generated-text">The report will be displayed here...</div>
                    <button id="copyBtn" class="mt-4 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 shadow-md">
                        Copy Text
                    </button>
                </div>
            </div>
        </div>
        <footer class="text-center mt-6 text-sm text-gray-400">
            <p>&copy; 2024 Created for SMKT (Terengganu).</p>
        </footer>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold">Sales History</h2>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2">Date</th>
                                <th class="p-2">Daily Sales (RM)</th>
                                <th class="p-2">Up to Date Sales (RM)</th>
                                <th class="p-2">Achievement (%)</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- Data sejarah akan dimasukkan di sini -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-10">
        <p id="toast-message"></p>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const SalesApp = {
            db: null,
            auth: null,
            appId: 'sales-calculator-app', // ID ini MESTI sepadan dengan ID dalam Firestore Rules anda

            // Rujukan kepada elemen-elemen DOM
            elements: {
                container: document.getElementById('app-container'),
                salesDate: document.getElementById('salesDate'),
                calculateBtn: document.getElementById('calculateBtn'),
                copyBtn: document.getElementById('copyBtn'),
                historyBtn: document.getElementById('historyBtn'),
                historyModal: document.getElementById('historyModal'),
                closeModalBtn: document.getElementById('closeModalBtn'),
                historyTableBody: document.getElementById('historyTableBody'),
                toast: document.getElementById('toast'),
                toastMessage: document.getElementById('toast-message'),
                output: document.getElementById('output'),
                // Tambah semua input fields di sini untuk rujukan mudah
                shopName: document.getElementById('shopName'),
                monthlyTarget: document.getElementById('monthlyTarget'),
                upToDateSales: document.getElementById('upToDateSales'),
                coreProduct: document.getElementById('coreProduct'),
                coreProductItems: document.getElementById('coreProductItems'),
                accessories: document.getElementById('accessories'),
                accessoriesItems: document.getElementById('accessoriesItems'),
                warranty: document.getElementById('warranty'),
                warrantyItems: document.getElementById('warrantyItems'),
                tradeIn: document.getElementById('tradeIn'),
                tradeInItems: document.getElementById('tradeInItems'),
                currentDay: document.getElementById('currentDay'),
                totalDays: document.getElementById('totalDays'),
            },

            // Fungsi untuk memulakan sambungan Firebase
            async initFirebase() {
                try {
                    const firebaseConfig = {
                        apiKey: "AIzaSyCWR7vfKgtNZrXutLmdd0163EhMUrLkBQA",
                        authDomain: "sales-report-app-ab55e.firebaseapp.com",
                        projectId: "sales-report-app-ab55e",
                        storageBucket: "sales-report-app-ab55e.appspot.com",
                        messagingSenderId: "357226489797",
                        appId: "1:357226489797:web:7beee72678971a468b8dac",
                        measurementId: "G-03PBVT3BDX"
                    };
                    const app = initializeApp(firebaseConfig);
                    this.db = getFirestore(app);
                    this.auth = getAuth(app);
                    await signInAnonymously(this.auth);
                    return true;
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    this.showError(`Database Connection Error! Could not initialize the database. Please check your Firebase configuration and security rules. Details: ${error.message}`);
                    return false;
                }
            },

            // Mengikat semua event listeners
            bindEvents() {
                this.elements.salesDate.addEventListener('change', () => {
                    this.updateDateFields();
                    this.loadDataForDate(this.elements.salesDate.value);
                });
                this.elements.calculateBtn.addEventListener('click', () => this.calculateAndSave());
                this.elements.copyBtn.addEventListener('click', () => this.copyReport());
                this.elements.historyBtn.addEventListener('click', () => this.showHistory());
                this.elements.closeModalBtn.addEventListener('click', () => this.hideModal());
                this.elements.historyModal.addEventListener('click', (e) => {
                    if (e.target === this.elements.historyModal) this.hideModal();
                });
            },

            // --- Fungsi Utama ---

            async calculateAndSave() {
                const salesDate = new Date(this.elements.salesDate.value);
                const data = {
                    shopName: this.elements.shopName.value,
                    monthlyTarget: parseFloat(this.elements.monthlyTarget.value) || 0,
                    previousUpToDateSales: parseFloat(this.elements.upToDateSales.value) || 0,
                    coreProductSales: parseFloat(this.elements.coreProduct.value) || 0,
                    accessoriesSales: parseFloat(this.elements.accessories.value) || 0,
                    warrantySales: parseFloat(this.elements.warranty.value) || 0,
                    tradeInSales: parseFloat(this.elements.tradeIn.value) || 0,
                    coreProductItems: this.elements.coreProductItems.value.trim(),
                    accessoriesItems: this.elements.accessoriesItems.value.trim(),
                    warrantyItems: this.elements.warrantyItems.value.trim(),
                    tradeInItems: this.elements.tradeInItems.value.trim(),
                    dateKey: this.formatDate(salesDate)
                };

                const dailySales = data.coreProductSales + data.accessoriesSales + data.warrantySales + data.tradeInSales;
                data.newUpToDateSales = data.previousUpToDateSales + dailySales;
                
                this.generateReport(data);
                
                // Simpan ke Firestore
                try {
                    const reportRef = doc(this.db, `artifacts/${this.appId}/public/data/salesReports/${data.dateKey}`);
                    await setDoc(reportRef, data);

                    const configRef = doc(this.db, `artifacts/${this.appId}/public/data/salesConfig/config`);
                    await setDoc(configRef, { shopName: data.shopName, monthlyTarget: data.monthlyTarget }, { merge: true });

                    this.showToast("Report saved successfully!");
                } catch (error) {
                    console.error("Error saving data:", error);
                    this.showToast("Failed to save report.", false);
                }
            },

            generateReport(data) {
                const salesDate = new Date(data.dateKey);
                // Tambah 1 hari untuk betulkan zon masa
                salesDate.setDate(salesDate.getDate() + 1);

                const currentDay = salesDate.getDate();
                const totalDays = new Date(salesDate.getFullYear(), salesDate.getMonth() + 1, 0).getDate();
                
                const dailySales = data.coreProductSales + data.accessoriesSales + data.warrantySales + data.tradeInSales;
                const upToDatePercent = data.monthlyTarget > 0 ? (data.newUpToDateSales / data.monthlyTarget) * 100 : 0;
                const estimatedClosing = currentDay > 0 ? (data.newUpToDateSales / currentDay) * totalDays : 0;
                const estimatedClosingPercent = data.monthlyTarget > 0 ? (estimatedClosing / data.monthlyTarget) * 100 : 0;
                
                const formattedDisplayDate = `${String(salesDate.getDate()).padStart(2, '0')}/${String(salesDate.getMonth() + 1).padStart(2, '0')}/${salesDate.getFullYear()}`;

                const breakdownParts = [];
                const categories = [
                    { title: 'Core Product', sales: data.coreProductSales, items: data.coreProductItems },
                    { title: 'Accessories', sales: data.accessoriesSales, items: data.accessoriesItems },
                    { title: 'Warranty', sales: data.warrantySales, items: data.warrantyItems },
                    { title: 'Trade In', sales: data.tradeInSales, items: data.tradeInItems },
                ];

                categories.forEach(cat => {
                    if (cat.sales > 0) {
                        let part = `${cat.title} : RM ${this.formatCurrency(cat.sales)}`;
                        if (cat.items) {
                            part += `\n${cat.items.split('\n').map(item => item.trim()).join('\n')}`;
                        }
                        breakdownParts.push(part);
                    }
                });
                
                const salesBreakdown = breakdownParts.join('\n\n');

                const outputText = 
`${data.shopName.toUpperCase()} ${formattedDisplayDate} Sales : RM ${this.formatCurrency(dailySales)}

${salesBreakdown}

Target : RM ${this.formatCurrency(data.monthlyTarget)}
Up to Date : RM ${this.formatCurrency(data.newUpToDateSales)} (${upToDatePercent.toFixed(0)}%)
Estimated Closing : RM ${this.formatCurrency(estimatedClosing)} (${estimatedClosingPercent.toFixed(0)}%)`;

                this.elements.output.textContent = outputText;
            },
            
            async loadDataForDate(dateKey) {
                try {
                    const configRef = doc(this.db, `artifacts/${this.appId}/public/data/salesConfig/config`);
                    const configSnap = await getDoc(configRef);
                    if (configSnap.exists()) {
                        const config = configSnap.data();
                        this.elements.shopName.value = config.shopName || 'SMKT';
                        this.elements.monthlyTarget.value = config.monthlyTarget || '';
                    }

                    const reportRef = doc(this.db, `artifacts/${this.appId}/public/data/salesReports/${dateKey}`);
                    const reportSnap = await getDoc(reportRef);

                    if (reportSnap.exists()) {
                        const data = reportSnap.data();
                        // DIBETULKAN: Peta data secara eksplisit untuk elak ralat nama
                        this.elements.upToDateSales.value = data.previousUpToDateSales || 0;
                        this.elements.coreProduct.value = data.coreProductSales || '';
                        this.elements.coreProductItems.value = data.coreProductItems || '';
                        this.elements.accessories.value = data.accessoriesSales || '';
                        this.elements.accessoriesItems.value = data.accessoriesItems || '';
                        this.elements.warranty.value = data.warrantySales || '';
                        this.elements.warrantyItems.value = data.warrantyItems || '';
                        this.elements.tradeIn.value = data.tradeInSales || '';
                        this.elements.tradeInItems.value = data.tradeInItems || '';
                        
                        // Jana laporan secara automatik
                        this.generateReport(data); 
                    } else {
                        this.resetDailyInputs();
                        const selectedDate = new Date(dateKey);
                        if (selectedDate.getDate() === 1) {
                            this.elements.upToDateSales.value = 0;
                        } else {
                            const yesterday = new Date(selectedDate);
                            yesterday.setDate(yesterday.getDate() - 1);
                            const yesterdayKey = this.formatDate(yesterday);
                            const yesterdayRef = doc(this.db, `artifacts/${this.appId}/public/data/salesReports/${yesterdayKey}`);
                            const yesterdaySnap = await getDoc(yesterdayRef);
                            
                            if (yesterdaySnap.exists() && yesterday.getMonth() === selectedDate.getMonth()) {
                                this.elements.upToDateSales.value = yesterdaySnap.data().newUpToDateSales || 0;
                            } else {
                                this.elements.upToDateSales.value = 0;
                            }
                        }
                        this.elements.output.textContent = 'The report will be displayed here...';
                    }
                } catch (error) {
                    console.error("Error loading data:", error);
                }
            },

            resetDailyInputs() {
                ['coreProduct', 'coreProductItems', 'accessories', 'accessoriesItems', 'warranty', 'warrantyItems', 'tradeIn', 'tradeInItems'].forEach(id => {
                    this.elements[id].value = '';
                });
            },

            // --- Fungsi Bantuan (UI & Utiliti) ---

            updateDateFields() {
                const dateValue = this.elements.salesDate.value;
                if (dateValue) {
                    const date = new Date(dateValue);
                    this.elements.currentDay.value = date.getDate();
                    this.elements.totalDays.value = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
                }
            },
            
            copyReport() {
                navigator.clipboard.writeText(this.elements.output.textContent).then(() => {
                    this.elements.copyBtn.textContent = 'Copied Successfully!';
                    this.elements.copyBtn.classList.replace('bg-green-600', 'bg-yellow-500');
                    setTimeout(() => {
                        this.elements.copyBtn.textContent = 'Copy Text';
                        this.elements.copyBtn.classList.replace('bg-yellow-500', 'bg-green-600');
                    }, 2000);
                });
            },

            async showHistory() {
                this.elements.historyTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">Loading history...</td></tr>';
                this.elements.historyModal.classList.remove('hidden');
                setTimeout(() => this.elements.historyModal.classList.remove('opacity-0'), 10);
                
                try {
                    const reportsCol = collection(this.db, `artifacts/${this.appId}/public/data/salesReports`);
                    const querySnapshot = await getDocs(query(reportsCol));
                    
                    const reports = [];
                    querySnapshot.forEach(doc => reports.push(doc.data()));
                    reports.sort((a, b) => new Date(b.dateKey) - new Date(a.dateKey));

                    this.elements.historyTableBody.innerHTML = ''; 
                    if (reports.length === 0) {
                        this.elements.historyTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">No history found.</td></tr>';
                    } else {
                        reports.forEach(report => {
                            const dailySales = (report.coreProductSales || 0) + (report.accessoriesSales || 0) + (report.warrantySales || 0) + (report.tradeInSales || 0);
                            const achievement = report.monthlyTarget > 0 ? ((report.newUpToDateSales || 0) / report.monthlyTarget) * 100 : 0;
                            const displayDate = new Date(report.dateKey);
                            // Tambah 1 hari untuk betulkan zon masa
                            displayDate.setDate(displayDate.getDate() + 1);

                            const row = `
                                <tr class="border-b">
                                    <td class="p-2">${displayDate.toLocaleDateString('en-GB')}</td>
                                    <td class="p-2">${this.formatCurrency(dailySales)}</td>
                                    <td class="p-2">${this.formatCurrency(report.newUpToDateSales)}</td>
                                    <td class="p-2">${achievement.toFixed(0)}%</td>
                                </tr>`;
                            this.elements.historyTableBody.innerHTML += row;
                        });
                    }
                } catch(error) {
                    console.error("Error fetching history: ", error);
                    this.elements.historyTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-red-500">Could not load history.</td></tr>';
                }
            },

            hideModal() {
                 this.elements.historyModal.classList.add('opacity-0');
                 setTimeout(() => this.elements.historyModal.classList.add('hidden'), 300);
            },

            showToast(message, isSuccess = true) {
                this.elements.toastMessage.textContent = message;
                this.elements.toast.className = 'toast fixed bottom-5 right-5 py-2 px-4 rounded-lg shadow-lg';
                this.elements.toast.classList.add(isSuccess ? 'bg-green-600' : 'bg-red-600', 'text-white');
                this.elements.toast.classList.remove('opacity-0', 'translate-y-10');
                setTimeout(() => this.elements.toast.classList.add('opacity-0', 'translate-y-10'), 3000);
            },

            showError(message) {
                if (this.elements.container) {
                    this.elements.container.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
                        <strong class="font-bold">Application Error!</strong>
                        <span class="block sm:inline">${message}</span>
                    </div>`;
                }
            },

            formatDate(date) {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            },

            formatCurrency(value) {
                return (value || 0).toLocaleString('ms-MY', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            },

            // Fungsi utama untuk memulakan keseluruhan aplikasi
            async init() {
                const isFirebaseReady = await this.initFirebase();
                if (isFirebaseReady) {
                    this.bindEvents();
                    this.elements.salesDate.value = this.formatDate(new Date());
                    this.updateDateFields();
                    await this.loadDataForDate(this.elements.salesDate.value);
                }
            }
        };

        // Mulakan aplikasi apabila DOM sedia
        document.addEventListener('DOMContentLoaded', () => {
            SalesApp.init();
        });

    </script>

</body>
</html>

